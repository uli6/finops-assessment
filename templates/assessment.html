<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment - FinOps</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 25px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .question-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .question-card.active {
            display: block;
        }

        .question-header {
            margin-bottom: 30px;
        }

        .question-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .meta-badge {
            background: #e7f3ff;
            color: #0066cc;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.3rem;
            color: #333;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .answer-section {
            margin-bottom: 30px;
        }

        .answer-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .answer-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .answer-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            margin-top: 20px;
        }

        .file-upload label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .file-upload input[type="file"] {
            width: 100%;
            padding: 15px;
            border: 2px dashed #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .file-upload input[type="file"]:hover {
            border-color: #667eea;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .completion-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .completion-card.active {
            display: block;
        }

        .completion-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .completion-card h2 {
            color: #28a745;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .completion-card p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .pre-assessment-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .question-text {
                font-size: 1.1rem;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .question-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã FinOps Assessment</h1>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-text" id="progress-text">Loading...</div>
        </div>

        <!-- Pre-Assessment Info Screen -->
        <div class="pre-assessment-card" id="pre-assessment-card" style="background: white; border-radius: 15px; padding: 40px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 700px; margin-left: auto; margin-right: auto;">
            <h2 style="color: #667eea; margin-bottom: 20px;">Before You Start the Assessment</h2>
            <ul style="color: #444; font-size: 1.1rem; margin-bottom: 30px; line-height: 1.7;">
                <li>üîí <strong>Privacy:</strong> Your data will be <b>anonymized</b> and <b>stored encrypted</b>. No sensitive information will be shared.</li>
                <li>‚è±Ô∏è <strong>Average time:</strong> The average time to complete this assessment is <b>15 to 20 minutes</b>.</li>
                <li>üíæ <strong>Continue later:</strong> You can <b>save your progress</b> at any time and continue later.</li>
                <li>ü§ñ <strong>Artificial Intelligence:</strong> Your answers will be analyzed by AI to generate personalized recommendations and automatic insights.</li>
                <li>üìé <strong>Evidence:</strong> Uploading documents, screenshots, or other evidence strengthens your assessment and recommendations.</li>
                <li>üõ°Ô∏è <strong>Security:</strong> Only you and authorized administrators will have access to the raw data.</li>
                <li>üìä <strong>Benchmark:</strong> Your results will be anonymously compared with the industry, without exposing your organization.</li>
                <li>‚ùì <strong>Questions:</strong> If you have any questions, please contact support.</li>
            </ul>
            <div style="display: flex; gap: 16px; justify-content: center;">
                <a href="/dashboard" class="btn btn-secondary">Return</a>
                <button class="btn" onclick="startAssessment()">Start Assessment</button>
            </div>
        </div>

        <div class="loading" id="loading" style="display:none;">
            <div class="spinner"></div>
            <h2>Loading Assessment</h2>
            <p>Preparing your personalized questions...</p>
        </div>

        <div class="question-card" id="question-card" style="display:none;">
            <div class="question-header">
                <div class="question-meta" id="question-meta">
                    <!-- Meta information will be populated here -->
                </div>
                <div class="question-text" id="question-text">
                    <!-- Question text will be populated here -->
                </div>
            </div>

            <div class="answer-section">
                <label for="answer">Your Response:</label>
                <textarea id="answer" name="answer" placeholder="Please provide a detailed response about your current practices, processes, and capabilities..."></textarea>
            </div>

            <div class="file-upload">
                <label for="evidence">Supporting Evidence (Optional):</label>
                <input type="file" id="evidence" name="evidence" accept=".pdf,.png,.jpg,.jpeg" multiple>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Upload documents, screenshots, or other evidence to support your response (PDF, PNG, JPG)
                </small>
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" id="prev-btn" onclick="previousQuestion()" disabled>Previous</button>
                <div>
                    <button class="btn btn-secondary" onclick="saveAndExit()">Save & Exit</button>
                    <button class="btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
                </div>
            </div>
        </div>

        <div class="completion-card" id="completion-card">
            <div class="completion-icon">üéâ</div>
            <h2>Assessment Completed!</h2>
            <p>Thank you for completing the FinOps maturity assessment. Your responses are being analyzed to provide personalized insights and recommendations.</p>
            <div class="navigation">
                <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
                <button class="btn" onclick="completeAssessment()">View Results</button>
            </div>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let questions = [];
        let responses = {};
        let assessmentId = null;

        // Show pre-assessment info first
        window.onload = function() {
            document.getElementById('pre-assessment-card').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('question-card').style.display = 'none';
        };

        function startAssessment() {
            document.getElementById('pre-assessment-card').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            loadAssessment();
        }

        // Load assessment data
        async function loadAssessment() {
            try {
                const response = await fetch('/get_assessment_progress');
                const data = await response.json();
                
                if (data.status === 'success') {
                    assessmentId = data.assessment_id;
                    questions = data.questions;
                    responses = data.responses || {};
                    
                    if (questions.length === 0) {
                        alert('No questions available. Please start a new assessment.');
                        window.location.href = '/dashboard';
                        return;
                    }
                    
                    // Find current question index
                    currentQuestionIndex = 0;
                    for (let i = 0; i < questions.length; i++) {
                        const key = `${questions[i].capability_id}_${questions[i].lens_id}`;
                        if (!responses[key]) {
                            currentQuestionIndex = i;
                            break;
                        }
                    }
                    
                    // Check if assessment is complete
                    if (currentQuestionIndex >= questions.length) {
                        showCompletion();
                        return;
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('question-card').style.display = 'block';
                    
                    showQuestion();
                } else {
                    alert(data.message || 'Error loading assessment');
                    window.location.href = '/dashboard';
                }
            } catch (error) {
                console.error('Error loading assessment:', error);
                alert('Connection error. Please try again.');
                window.location.href = '/dashboard';
            }
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showCompletion();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            const key = `${question.capability_id}_${question.lens_id}`;
            
            // Update meta information
            const metaHtml = `
                <div class="meta-badge">Capability: ${question.capability_name}</div>
                <div class="meta-badge">Lens: ${question.lens_name}</div>
                <div class="meta-badge">Domain: ${question.domain}</div>
            `;
            document.getElementById('question-meta').innerHTML = metaHtml;
            
            // Update question text
            document.getElementById('question-text').textContent = question.question;
            
            // Load existing response if any
            const existingResponse = responses[key];
            document.getElementById('answer').value = existingResponse ? existingResponse.answer : '';
            
            // Update progress
            updateProgress();
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').textContent = 
                currentQuestionIndex === questions.length - 1 ? 'Complete Assessment' : 'Next Question';
        }

        function updateProgress() {
            const completed = Object.keys(responses).length;
            const total = questions.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = 
                `Question ${currentQuestionIndex + 1} of ${total} (${completed} completed)`;
        }

        async function saveCurrentResponse() {
            const answer = document.getElementById('answer').value.trim();
            
            if (!answer) {
                alert('Please provide a response before continuing.');
                return false;
            }
            
            const question = questions[currentQuestionIndex];
            const formData = new FormData();
            formData.append('capability_id', question.capability_id);
            formData.append('lens_id', question.lens_id);
            formData.append('answer', answer);
            
            // Add file uploads
            const evidenceFiles = document.getElementById('evidence').files;
            for (let i = 0; i < evidenceFiles.length; i++) {
                formData.append('evidence', evidenceFiles[i]);
            }
            
            try {
                const response = await fetch('/submit_assessment', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Update local responses
                    const key = `${question.capability_id}_${question.lens_id}`;
                    responses[key] = { answer: answer };
                    
                    // Clear file input for next question
                    document.getElementById('evidence').value = '';
                    
                    return true;
                } else {
                    alert(result.message || 'Error saving response');
                    return false;
                }
            } catch (error) {
                console.error('Error saving response:', error);
                alert('Connection error. Please try again.');
                return false;
            }
        }

        async function nextQuestion() {
            if (await saveCurrentResponse()) {
                currentQuestionIndex++;
                
                if (currentQuestionIndex >= questions.length) {
                    showCompletion();
                } else {
                    showQuestion();
                }
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        async function saveAndExit() {
            const answer = document.getElementById('answer').value.trim();
            
            if (answer && await saveCurrentResponse()) {
                alert('Progress saved successfully!');
            }
            
            window.location.href = '/dashboard';
        }

        function showCompletion() {
            document.getElementById('question-card').style.display = 'none';
            document.getElementById('completion-card').style.display = 'block';
            updateProgress();
        }

        async function completeAssessment() {
            try {
                const response = await fetch('/complete_assessment', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    window.location.href = `/get_assessment_results/${assessmentId}`;
                } else {
                    alert(result.message || 'Error completing assessment');
                }
            } catch (error) {
                console.error('Error completing assessment:', error);
                alert('Connection error. Please try again.');
            }
        }

        // Load assessment when page loads
        // window.addEventListener('load', loadAssessment); // This line is now handled by startAssessment
    </script>
</body>
</html>

